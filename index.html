<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Controle de Toner e Tinta</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
  .container { max-width:1000px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 8px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#444; }
  form { display:grid; gap:10px; margin-bottom:20px; }
  label { font-weight:bold; }
  input, select, button { padding:8px; font-size:14px; border-radius:5px; border:1px solid #ccc; }
  button { cursor:pointer; background:#40739e; color:white; border:none; }
  button:hover { background:#2f5d83; }
  table { width:100%; border-collapse:collapse; margin-top:10px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#40739e; color:white; }
  nav { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
  .menu-btn { background:#999; }
  .menu-btn.active { background:#2f5d83; color:white; }
  section { display:none; }
  section.active { display:block; }
  .btn-acoes { display:flex; gap:5px; justify-content:center; }
  .btn-editar { background:#e1b12c; }
  .btn-excluir { background:#e84118; }
  #filtrosRelatorio { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:15px; margin-bottom:15px; }
</style>
</head>
<body>
<div class="container">
  <h2>Controle de Toners</h2>

  <!-- MENU -->
  <nav>
    <button class="menu-btn active" data-section="secControle">Controle de Trocas</button>
    <button class="menu-btn" data-section="secCadastro">Cadastro de Toners</button>
    <button class="menu-btn" data-section="secConsulta">Consulta de Toners</button>
  </nav>

  <!-- SE√á√ÉO 1: CONTROLE DE TROCAS -->
  <section id="secControle" class="active">
    <form id="formRegistro">
      <label>Nome da Escola:</label>
      <input list="listaEscolas" id="escola" required>
      <datalist id="listaEscolas"></datalist>

      <label>Modelo do Toner/Tinta:</label>
      <input list="listaModelos" id="modelo" required>
      <datalist id="listaModelos"></datalist>

      <label>Quantidade:</label>
      <input type="number" id="quantidade" min="1" required>

      <label>Data da Opera√ß√£o:</label>
      <input type="date" id="data" required>

      <label>Tipo de Opera√ß√£o:</label>
      <select id="tipoOperacao" required>
        <option value="">Selecione...</option>
        <option value="Troca">Troca</option>
        <option value="Recarga">Recarga</option>
      </select>

      <button type="submit" id="btnSalvar">Registrar</button>
      <button type="button" id="btnCancelarEdicao" style="display:none; background:#999;">Cancelar</button>
    </form>

    <!-- FILTROS DE RELAT√ìRIO -->
    <div id="filtrosRelatorio">
      <input type="text" id="filtroEscola" placeholder="Filtrar por escola...">
      <input type="month" id="filtroMes">
      <button id="btnImprimirTodos">üñ®Ô∏è Imprimir Todos</button>
      <button id="btnImprimirFiltrado">üñ®Ô∏è Imprimir Filtrado</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Escola</th>
          <th>Modelo</th>
          <th>Quantidade</th>
          <th>Data</th>
          <th>Tipo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaRegistros"></tbody>
    </table>
  </section>

  <!-- SE√á√ÉO 2: CADASTRO DE TONERS -->
  <section id="secCadastro">
    <h3>Cadastro de Modelos de Toner</h3>
    <form id="formCadastroToner">
      <label>Modelo:</label>
      <input type="text" id="cadModelo" required>

      <label>Quantidade:</label>
      <input type="number" id="cadQuantidade" min="1" required>

      <label>Impressora:</label>
      <input type="text" id="cadImpressora" required>

      <button type="submit" id="btnSalvarToner">Cadastrar</button>
      <button type="button" id="btnCancelarToner" style="display:none; background:#999;">Cancelar</button>
    </form>

    <table>
      <thead>
        <tr>
          <th>Modelo</th>
          <th>Quantidade</th>
          <th>Impressora</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="tabelaToners"></tbody>
    </table>
  </section>

  <!-- SE√á√ÉO 3: CONSULTA DE TONERS -->
  <section id="secConsulta">
    <h3>Consulta de Toners Cadastrados</h3>
    <input type="text" id="filtroModeloConsulta" placeholder="Filtrar por modelo...">
    <table>
      <thead>
        <tr>
          <th>Modelo</th>
          <th>Quantidade</th>
          <th>Impressora</th>
        </tr>
      </thead>
      <tbody id="tabelaConsulta"></tbody>
    </table>
  </section>
</div>

<!-- SCRIPT FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, getDocs, where, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/11.8.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBSAMAhiEbBPCNqNpv-dM64Pa_xclwqc54",
    authDomain: "controletoner.firebaseapp.com",
    projectId: "controletoner",
    storageBucket: "controletoner.firebasestorage.app",
    messagingSenderId: "821741941730",
    appId: "1:821741941730:web:32bd9d82c58deef8a37fbb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ===== MENU =====
  const botoesMenu = document.querySelectorAll('.menu-btn');
  const secoes = document.querySelectorAll('section');
  botoesMenu.forEach(botao=>{
    botao.addEventListener('click',()=>{
      botoesMenu.forEach(b=>b.classList.remove('active'));
      secoes.forEach(s=>s.classList.remove('active'));
      botao.classList.add('active');
      document.getElementById(botao.dataset.section).classList.add('active');
    });
  });

  function escapeHtml(str){return String(str||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

  // ======== CONTROLE DE TROCAS ==========
  const formRegistro = document.getElementById('formRegistro');
  const tabelaRegistros = document.getElementById('tabelaRegistros');
  const escola = document.getElementById('escola');
  const modelo = document.getElementById('modelo');
  const quantidade = document.getElementById('quantidade');
  const data = document.getElementById('data');
  const tipoOperacao = document.getElementById('tipoOperacao');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
  const filtroEscola = document.getElementById('filtroEscola');
  const filtroMes = document.getElementById('filtroMes');
  const btnImprimirTodos = document.getElementById('btnImprimirTodos');
  const btnImprimirFiltrado = document.getElementById('btnImprimirFiltrado');

  let registros = [];
  let idEmEdicao = null;

  function carregarTrocas(){
    const q = query(collection(db,'registros'), orderBy('data','desc'));
    onSnapshot(q, snap=>{
      registros = [];
      tabelaRegistros.innerHTML='';
      snap.forEach(docSnap=>{
        const r=docSnap.data();
        registros.push({...r, id: docSnap.id});
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(r.escola)}</td>
          <td>${escapeHtml(r.modelo)}</td>
          <td>${r.quantidade}</td>
          <td>${r.data}</td>
          <td>${escapeHtml(r.tipo)}</td>
          <td class="btn-acoes">
            <button class="btn-editar" data-id="${docSnap.id}">‚úèÔ∏è</button>
            <button class="btn-excluir" data-id="${docSnap.id}">üóëÔ∏è</button>
          </td>`;
        tabelaRegistros.appendChild(tr);
      });
      aplicarEventos();
      atualizarListas();
      aplicarFiltros();
    });
  }
  carregarTrocas();

  function aplicarEventos(){
    document.querySelectorAll('.btn-excluir').forEach(btn=>{
      btn.onclick = async ()=>{
        if(confirm("Deseja excluir este registro?")){
          await deleteDoc(doc(db,'registros',btn.dataset.id));
        }
      };
    });
    document.querySelectorAll('.btn-editar').forEach(btn=>{
      btn.onclick = ()=>{
        const d = registros.find(r=>r.id===btn.dataset.id);
        if(!d) return;
        idEmEdicao = d.id;
        escola.value = d.escola;
        modelo.value = d.modelo;
        quantidade.value = d.quantidade;
        data.value = d.data;
        tipoOperacao.value = d.tipo;
        btnSalvar.textContent = "Salvar Altera√ß√µes";
        btnCancelarEdicao.style.display = "inline-block";
      };
    });
  }

  btnCancelarEdicao.onclick = ()=>{
    idEmEdicao=null;
    formRegistro.reset();
    btnSalvar.textContent="Registrar";
    btnCancelarEdicao.style.display="none";
  };

  formRegistro.addEventListener('submit', async e=>{
    e.preventDefault();
    const novaOperacao = {
      escola: escola.value.trim(),
      modelo: modelo.value.trim(),
      quantidade: parseInt(quantidade.value),
      data: data.value,
      tipo: tipoOperacao.value
    };
    if(!novaOperacao.escola || !novaOperacao.modelo || !novaOperacao.quantidade || !novaOperacao.data || !novaOperacao.tipo){
      alert('Preencha todos os campos.');
      return;
    }
    if(idEmEdicao){
      await updateDoc(doc(db,'registros',idEmEdicao), novaOperacao);
      idEmEdicao=null;
      formRegistro.reset();
      btnSalvar.textContent="Registrar";
      btnCancelarEdicao.style.display="none";
      alert("Registro atualizado!");
      return;
    }
    if(novaOperacao.tipo === "Recarga"){
      await addDoc(collection(db, 'registros'), novaOperacao);
      alert("Recarga registrada!");
      formRegistro.reset();
      return;
    }
    const q = query(collection(db,'toners'), where('modelo','==',novaOperacao.modelo));
    const qsnap = await getDocs(q);
    if(qsnap.empty){ alert("Modelo n√£o encontrado no estoque!"); return; }
    const tonerDoc = qsnap.docs[0];
    const tonerData = tonerDoc.data();
    const novaQtd = tonerData.quantidade - novaOperacao.quantidade;
    if(novaQtd < 0){ alert("Estoque insuficiente!"); return; }
    await updateDoc(doc(db,'toners',tonerDoc.id), {quantidade: novaQtd});
    await addDoc(collection(db,'registros'), novaOperacao);
    alert("Troca registrada e estoque atualizado!");
    formRegistro.reset();
  });

  // ===== FILTROS DIN√ÇMICOS =====
  filtroEscola.addEventListener('input', aplicarFiltros);
  filtroMes.addEventListener('input', aplicarFiltros);

  function aplicarFiltros(){
    const escolaFiltro = filtroEscola.value.toLowerCase();
    const mesFiltro = filtroMes.value;
    const linhas = tabelaRegistros.querySelectorAll('tr');
    linhas.forEach(linha=>{
      const escola = linha.children[0].textContent.toLowerCase();
      const data = linha.children[3].textContent;
      const coincideEscola = escola.includes(escolaFiltro);
      const coincideMes = !mesFiltro || data.startsWith(mesFiltro);
      linha.style.display = (coincideEscola && coincideMes)?'':'none';
    });
  }

  // ======== RELAT√ìRIO IMPRESSO ==========
  function gerarRelatorio(filtroEscolaVal='', filtroMesVal=''){
    let filtrados = registros;
    if(filtroEscolaVal) filtrados = filtrados.filter(r=>r.escola.toLowerCase().includes(filtroEscolaVal.toLowerCase()));
    if(filtroMesVal) filtrados = filtrados.filter(r=>r.data.startsWith(filtroMesVal));
    if(filtrados.length===0){ alert('Nenhum registro encontrado.'); return; }
    let html = `<h2 style="text-align:center;">Relat√≥rio de Trocas e Recargas</h2>`;
    html += `<p><strong>Data de Emiss√£o:</strong> ${new Date().toLocaleDateString()}</p>`;
    if(filtroMesVal){
      const [ano, mes] = filtroMesVal.split('-');
      const meses=['Janeiro','Fevereiro','Mar√ßo','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
      html += `<p><strong>M√™s:</strong> ${meses[parseInt(mes)-1]} de ${ano}</p>`;
    }
    if(filtroEscolaVal) html += `<p><strong>Escola:</strong> ${escapeHtml(filtroEscolaVal)}</p>`;
    html += `<table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse;">
    <tr style="background:#eee;"><th>Escola</th><th>Modelo</th><th>Quantidade</th><th>Data</th><th>Tipo</th></tr>`;
    filtrados.forEach(r=>{
      html += `<tr><td>${escapeHtml(r.escola)}</td><td>${escapeHtml(r.modelo)}</td><td>${r.quantidade}</td><td>${r.data}</td><td>${escapeHtml(r.tipo)}</td></tr>`;
    });
    html += `</table>`;
    const w = window.open();
    w.document.write(html);
    w.document.close();
    w.print();
  }

  btnImprimirTodos.onclick = ()=>gerarRelatorio();
  btnImprimirFiltrado.onclick = ()=>gerarRelatorio(filtroEscola.value, filtroMes.value);

  // ======== CADASTRO DE TONERS ==========
  const formCadastroToner=document.getElementById('formCadastroToner');
  const tabelaToners=document.getElementById('tabelaToners');
  const tabelaConsulta=document.getElementById('tabelaConsulta');
  const btnSalvarToner=document.getElementById('btnSalvarToner');
  const btnCancelarToner=document.getElementById('btnCancelarToner');
  let idTonerEdicao = null;

  function carregarToners(){
    const q = query(collection(db,'toners'), orderBy('modelo'));
    onSnapshot(q, snap=>{
      tabelaToners.innerHTML='';
      tabelaConsulta.innerHTML='';
      snap.forEach(docSnap=>{
        const d=docSnap.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHtml(d.modelo)}</td>
          <td>${d.quantidade}</td>
          <td>${escapeHtml(d.impressora)}</td>
          <td class="btn-acoes">
            <button class="btn-editar" data-id="${docSnap.id}">‚úèÔ∏è</button>
            <button class="btn-excluir" data-id="${docSnap.id}">üóëÔ∏è</button>
          </td>`;
        tabelaToners.appendChild(tr);
        const tr2=document.createElement('tr');
        tr2.innerHTML=`<td>${escapeHtml(d.modelo)}</td><td>${d.quantidade}</td><td>${escapeHtml(d.impressora)}</td>`;
        tabelaConsulta.appendChild(tr2);
      });
      aplicarFiltroConsulta();
      document.querySelectorAll('#tabelaToners .btn-excluir').forEach(btn=>{
        btn.onclick = async ()=>{ if(confirm("Excluir este toner?")) await deleteDoc(doc(db,'toners',btn.dataset.id)); };
      });
      document.querySelectorAll('#tabelaToners .btn-editar').forEach(btn=>{
        btn.onclick = async ()=>{
          const snap = await getDocs(query(collection(db,'toners'), where('__name__','==',btn.dataset.id)));
          if(!snap.empty){
            const d = snap.docs[0].data();
            idTonerEdicao = btn.dataset.id;
            cadModelo.value = d.modelo;
            cadQuantidade.value = d.quantidade;
            cadImpressora.value = d.impressora;
            btnSalvarToner.textContent="Salvar Altera√ß√µes";
            btnCancelarToner.style.display="inline-block";
          }
        };
      });
    });
  }
  carregarToners();

  // ======== FILTRO DE CONSULTA DE TONERS ========
  const filtroModeloConsulta = document.getElementById('filtroModeloConsulta');
  filtroModeloConsulta.addEventListener('input', aplicarFiltroConsulta);
  function aplicarFiltroConsulta(){
    const termo = filtroModeloConsulta.value.toLowerCase();
    const linhas = tabelaConsulta.querySelectorAll('tr');
    linhas.forEach(linha=>{
      const modelo = linha.children[0].textContent.toLowerCase();
      linha.style.display = modelo.includes(termo)?'':'none';
    });
  }

  btnCancelarToner.onclick = ()=>{
    idTonerEdicao=null;
    formCadastroToner.reset();
    btnSalvarToner.textContent="Cadastrar";
    btnCancelarToner.style.display="none";
  };

  formCadastroToner.addEventListener('submit', async e=>{
    e.preventDefault();
    const novo = {
      modelo: cadModelo.value.trim(),
      quantidade: parseInt(cadQuantidade.value),
      impressora: cadImpressora.value.trim()
    };
    if(!novo.modelo || !novo.quantidade || !novo.impressora){ alert("Preencha todos os campos!"); return; }
    if(idTonerEdicao){
      await updateDoc(doc(db,'toners',idTonerEdicao), novo);
      idTonerEdicao=null;
      btnSalvarToner.textContent="Cadastrar";
      btnCancelarToner.style.display="none";
      formCadastroToner.reset();
      alert("Toner atualizado!");
    }else{
      await addDoc(collection(db,'toners'),novo);
      formCadastroToner.reset();
      alert('Toner cadastrado!');
    }
  });

  // ======== ATUALIZA LISTAS DE ESCOLAS E MODELOS ========
  function atualizarListas(){
    const escolas = [...new Set(registros.map(r => r.escola))];
    const modelos = [...new Set(registros.map(r => r.modelo))];
    const listaEscolas = document.getElementById('listaEscolas');
    const listaModelos = document.getElementById('listaModelos');
    listaEscolas.innerHTML = escolas.map(e => `<option value="${escapeHtml(e)}">`).join('');
    listaModelos.innerHTML = modelos.map(m => `<option value="${escapeHtml(m)}">`).join('');
  }
</script>
</body>
</html>
